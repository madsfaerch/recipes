---
import { getCollection, render } from 'astro:content';
import Base from '../layouts/Base.astro';
import RecipeInteractive from '../components/RecipeInteractive';

export async function getStaticPaths() {
  const recipes = await getCollection('recipes');
  return recipes.map((recipe) => ({
    params: { id: recipe.id },
    props: { recipe },
  }));
}

const { recipe } = Astro.props;
const { Content } = await render(recipe);

// Parse ingredient groups from raw markdown body
function parseIngredientGroups(body: string) {
  const lines = body.split('\n');
  const groups: { heading?: string; items: { text: string }[] }[] = [];
  let inIngredients = false;
  let currentGroup: { heading?: string; items: { text: string }[] } | null = null;

  for (const line of lines) {
    const trimmed = line.trim();

    if (/^##\s+ingredients/i.test(trimmed)) {
      inIngredients = true;
      currentGroup = { items: [] };
      groups.push(currentGroup);
      continue;
    }

    if (inIngredients && /^##\s+/.test(trimmed) && !/ingredients/i.test(trimmed)) {
      inIngredients = false;
      currentGroup = null;
      continue;
    }

    if (!inIngredients) continue;

    if (/^###\s+/.test(trimmed)) {
      const heading = trimmed.replace(/^###\s+/, '');
      currentGroup = { heading, items: [] };
      groups.push(currentGroup);
      continue;
    }

    if (/^-\s+/.test(trimmed) && currentGroup) {
      const text = trimmed.replace(/^-\s+/, '').replace(/\*\*/g, '');
      currentGroup.items.push({ text });
    }
  }

  return groups;
}

const ingredientGroups = parseIngredientGroups(recipe.body || '');
const originalServings = parseInt(recipe.data.servings || '0', 10);
const hasInteractive = originalServings > 0 && ingredientGroups.length > 0;
---

<Base title={recipe.data.title}>
  <article>
    <a href="/" class="text-sm text-stone-400 hover:text-spice transition-colors mb-6 inline-block">
      â† Back to recipes
    </a>

    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-stone-900 mb-3">{recipe.data.title}</h1>
      {recipe.data.description && (
        <p class="text-lg text-stone-500">{recipe.data.description}</p>
      )}

      <div class="flex flex-wrap gap-4 mt-4 text-sm text-stone-500">
        {recipe.data.cuisine && <span>ğŸŒ {recipe.data.cuisine}</span>}
        {recipe.data.servings && !hasInteractive && <span>ğŸ½ {recipe.data.servings}</span>}
        {recipe.data.prepTime && <span>â± Prep: {recipe.data.prepTime}</span>}
        {recipe.data.cookTime && <span>ğŸ”¥ Cook: {recipe.data.cookTime}</span>}
      </div>

      {recipe.data.tags && (
        <div class="flex flex-wrap gap-2 mt-4">
          {recipe.data.tags.map((tag: string) => (
            <span class="text-xs px-2.5 py-1 bg-stone-100 rounded-full text-stone-500">{tag}</span>
          ))}
        </div>
      )}
    </header>

    <div id="recipe-content" class="prose prose-stone prose-headings:font-serif prose-h2:text-xl prose-h2:mt-8 prose-h2:mb-4 prose-li:my-0.5 max-w-none">
      {hasInteractive && (
        <RecipeInteractive
          client:load
          originalServings={originalServings}
          ingredientGroups={ingredientGroups}
          shoppingIngredients={recipe.data.shoppingIngredients}
        />
      )}
      <Content />
    </div>

    {(recipe.data.author || recipe.data.source) && (
      <div class="mt-10 pt-6 border-t border-stone-200 text-sm text-stone-400 space-y-1">
        {recipe.data.author && <p>By {recipe.data.author}</p>}
        {recipe.data.source && (
          <p>Source: <a href={recipe.data.source} target="_blank" rel="noopener" class="text-spice hover:underline">{recipe.data.source}</a></p>
        )}
      </div>
    )}
  </article>

  {hasInteractive && (
    <script>
      // Hide markdown-rendered ingredients section (React takes over)
      const reactEl = document.getElementById('react-ingredients');
      if (reactEl) {
        const content = document.getElementById('recipe-content');
        if (content) {
          let hide = false;
          for (const child of Array.from(content.children)) {
            if (child.tagName === 'H2' && /ingredients/i.test(child.textContent || '')) {
              hide = true;
              (child as HTMLElement).style.display = 'none';
              continue;
            }
            if (child.tagName === 'H2' && hide) {
              hide = false;
            }
            if (hide && child.id !== 'react-ingredients' && !child.querySelector('#react-ingredients')) {
              (child as HTMLElement).style.display = 'none';
            }
          }
        }
      }
    </script>
  )}
</Base>
